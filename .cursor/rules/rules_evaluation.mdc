---
description: 会话结束时触发，规则评估与持续优化
globs:
alwaysApply: false
---

# 规则评估与持续优化

## 时间处理规范

1. **评估报告文件命名**：
   - 格式：`evaluation-{YYYY-MM-DD-HH-mm-ss}.md`
   - 示例：`evaluation-2025-03-25-19-45-30.md`
   - 获取命令：`date '+%Y-%m-%d-%H-%M-%S'`

2. **评估时间记录**：
   - 状态记录：使用ISO格式（YYYY-MM-DDThh:mm:ss±hh:mm）
   - 显示时间：使用人类可读格式（YYYY-MM-DD HH:mm:ss）
   - 时间间隔：使用标准时间差表示（如：7d, 30d）

## 评估报告格式

```markdown
# 规则评估报告

生成时间：{YYYY-MM-DD HH:mm:ss}
评估周期：{YYYY-MM-DD} 至 {YYYY-MM-DD}

## 评估概要
- 评估规则总数：{数量}
- 触发次数：{次数}
- 成功率：{百分比}%
- 平均响应时间：{时间}ms

## 规则详情
1. {规则名称}
   - 最后触发：{YYYY-MM-DD HH:mm:ss}
   - 触发次数：{次数}
   - 成功率：{百分比}%
   - 平均耗时：{时间}ms

## 改进建议
{建议列表}

## 下次评估
计划时间：{YYYY-MM-DD HH:mm:ss}
```

## 评估周期

1. **轻量级评估**（每25条消息）：
   - 记录评估时间戳（ISO格式）
   - 计算距离上次评估的时间间隔
   - 生成简要报告

2. **标准评估**（会话结束时）：
   - 记录完整的时间信息
   - 包含会话持续时间
   - 生成标准评估报告

3. **深度评估**（每月或5次会话后）：
   - 记录详细的时间统计
   - 分析长期趋势
   - 生成完整评估报告

## 状态记录格式

```json
{
  "last_evaluation": {
    "light": "2025-03-25T19:45:30+08:00",
    "standard": "2025-03-25T19:45:30+08:00",
    "deep": "2025-03-25T19:45:30+08:00"
  },
  "next_evaluation": {
    "light": "2025-03-25T20:45:30+08:00",
    "standard": "2025-03-26T19:45:30+08:00",
    "deep": "2025-04-25T19:45:30+08:00"
  },
  "evaluation_history": [
    {
      "type": "light",
      "timestamp": "2025-03-25T19:45:30+08:00",
      "duration": "300",
      "rules_evaluated": 10
    }
  ]
}
```

## 错误处理规范

1. **时间获取错误**：
   - 记录错误日志
   - 使用备用时间获取方式
   - 通知用户时间获取异常

2. **时间格式验证**：
   - 验证ISO格式时间
   - 验证文件名时间戳格式
   - 验证显示时间格式

3. **评估周期计算**：
   - 处理时区转换
   - 考虑月末和闰年情况
   - 处理时间计算溢出

## 注意事项

1. 所有时间记录必须遵循统一的格式标准
2. 评估报告文件名必须包含准确的时间戳
3. 状态记录必须使用ISO格式时间
4. 显示时间时使用人类可读格式
5. 必须正确处理时区信息
6. 评估间隔必须准确计算
7. 时间相关的错误必须妥善处理

为确保项目规则的持续有效性和适用性，智能体应定期评估规则的执行情况，收集反馈并提出改进建议。

## 自动触发机制

规则评估将在以下情况自动触发：

1. **用户明确请求**：
   - 当用户输入"规则评估"、"/evaluate-rules"、"/规则评估"等关键词时
   - 当用户询问关于规则效果或规则系统状态的问题时

2. **会话里程碑**：
   - 每25条消息自动触发一次轻量级评估
   - 每个会话结束前执行一次完整评估
   - 项目里程碑达成时（如完成重要功能、解决关键问题）

3. **规则变更后**：
   - 添加新规则后自动评估其与现有规则的兼容性
   - 修改现有规则后评估变更影响
   - 禁用或删除规则后评估系统完整性

4. **性能异常检测**：
   - 检测到规则执行时间异常时
   - 发现规则冲突或不一致行为时
   - 用户反馈体验问题时

## 评估级别

1. **轻量级评估**（25条消息触发）：
   - 仅评估本会话中触发的规则
   - 关注明显的问题和冲突
   - 生成简短的内部报告

2. **标准评估**（会话结束触发）：
   - 评估所有活跃规则的效果
   - 检查规则覆盖范围
   - 记录触发频率和有效性
   - 生成完整的评估报告

3. **深度评估**（每月或5次会话后）：
   - 全面分析所有规则
   - 进行规则间依赖和冲突分析
   - 构建规则关系图
   - 生成详细的评估报告和改进建议

## 评估周期

1. **会话内评估**：
   - 在每次会话中记录规则触发情况
   - 跟踪规则应用是否达到预期效果
   - 识别潜在的规则冲突或盲点

2. **定期总结评估**：
   - 每5次会话或每月（以先到者为准）进行一次全面评估
   - 分析规则应用频率和效果
   - 评估规则覆盖范围的充分性

## 评估维度

1. **有效性**：
   - 规则是否实现了预期目标
   - 用户是否需要频繁纠正智能体行为
   - 规则触发是否及时准确

2. **适用性**：
   - 规则是否适合当前项目阶段
   - 是否存在过于严格或宽松的规则
   - 规则是否影响开发效率

3. **冲突与重叠**：
   - 识别相互矛盾的规则
   - 发现功能重叠的规则
   - 检测规则间的依赖关系

## 评估实现

### 触发评估命令

要明确触发规则评估，可使用以下命令：

- `/evaluate-rules` 或 `/规则评估` - 执行完整规则评估
- `/evaluate-rules light` 或 `/规则评估 轻量` - 执行轻量级评估
- `/evaluate-rules deep` 或 `/规则评估 深度` - 执行深度评估
- `/evaluate-rules [rule_name]` 或 `/规则评估 [规则名]` - 评估特定规则

### 评估状态跟踪

系统使用状态文件跟踪评估记录：
- 状态文件路径：`.cursor/states/rules_evaluation_state.json`
- 记录内容：
  - 上次评估时间
  - 评估计数器
  - 各规则触发次数
  - 待改进规则列表
  - 用户反馈记录

### 评估报告生成

评估完成后，系统将自动生成评估报告：
1. 轻量级评估：生成内部报告，不创建文件
2. 标准评估：在会话中提供简要报告
3. 深度评估：创建完整报告文件（`docs/exploration/evaluation/evaluation-{YYYY-MM-DD-HH-mm-ss}.md`）

### 报告模板

深度评估报告遵循以下结构：

```markdown
# 规则评估报告 ({日期})

## 总体评估
- 规则总数：{数量}
- 高效规则：{数量} ({百分比}%)
- 需改进规则：{数量} ({百分比}%)
- 建议新增规则：{数量}

## 详细评估

### 高效规则
{逐一列出高效规则及其效果}

### 需改进规则
{逐一列出需改进规则及具体问题}

### 建议新增规则
{列出建议创建的新规则}

## 行动计划
{列出具体改进行动}

## 规则触发统计
{规则触发频率表格}

## 用户反馈摘要
{用户反馈汇总}
```

## 跟踪方法

1. **自动记录**：
   - 记录每条规则的触发次数
   - 跟踪规则触发后的用户响应（接受/拒绝/修改）
   - 收集规则执行时间和资源消耗

2. **用户反馈**：
   - 主动征求用户对规则有效性的评价
   - 记录用户提出的规则相关问题
   - 注意用户表现出的不满或困惑

## 优化流程

1. **收集信息**：
   - 整合自动记录的数据
   - 汇总用户反馈
   - 结合项目进展情况

2. **分析问题**：
   - 识别低效或无效规则
   - 发现未覆盖的关键领域
   - 评估规则复杂度与实用性平衡

3. **提出建议**：
   - 生成具体的规则修改建议
   - 提出新规则以填补空白
   - 建议合并或简化冗余规则

4. **实施改进**：
   - 与用户确认改进方案
   - 更新现有规则文件
   - 创建新规则文件

## 反馈机制

在每次会话结束时或用户提出规则相关问题时，使用类似以下格式提供规则评估反馈：

```
## 规则有效性评估

在本次会话中，我观察到以下规则的应用情况：

1. **规则名称**：[规则名]
   - 触发次数：[次数]
   - 效果评估：[良好/一般/需改进]
   - 改进建议：[具体建议]

2. **未覆盖领域**：
   - [发现的未覆盖领域]
   - 建议添加规则：[建议内容]

您对当前规则的应用是否满意？有什么希望改进的地方吗？
```

通过持续的评估和优化循环，确保项目规则始终保持高效、相关和实用，为项目开发提供最佳支持。